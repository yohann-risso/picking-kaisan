(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const i={produtos:[],retirados:[],tempoInicio:null,cronometroInterval:null};function w(){return{apikey:void 0,Authorization:"Bearer undefined","Content-Type":"application/json"}}function L(e,t=!1){var a,c;const o=Object.values(e.distribuicaoAtual).reduce((d,p)=>d+p,0),r=((a=e.endereco)==null?void 0:a.split("‚Ä¢")[0])||"SEM LOCAL",n=((c=e.endereco)==null?void 0:c.split("‚Ä¢")[1])||"‚Äî",s=["A","B","C","D"].map(d=>`
    <div class="col minicard">
      <div class="card text-center">
        <div class="card-header fw-bold text-secondary">${d}</div>
        <div class="card-body p-2">
          <h4 class="card-title text-danger m-0">${e.distribuicaoAtual[d]}</h4>
        </div>
      </div>
    </div>`).join(""),l=document.createElement("div");return l.className="col-12 col-md-6 col-lg-4 card-wrapper",l.innerHTML=`
    <div class="card card-produto ${t?"primary":""} h-100 p-3">
      <div class="row g-3">
        <div class="col-md-4 text-center">
          <img src="${e.imagem||""}" alt="${e.descricao||"Produto"}"
               class="img-fluid rounded shadow-sm card-img-produto" style="max-height: 250px;">
        </div>
        <div class="col-md-8">
          <p class="fw-bold fs-3 mb-1 endereco-label">
            ENDERE√áO: <span class="texto-endereco d-block">${r}</span>
          </p>
          <span onclick="zerarEnderecoExterno('${r}')" style="cursor:pointer;" title="Zerar Endere√ßo">
            <i class="bi bi-x-circle-fill text-danger ms-2 fs-5"></i>
            <span class="spinner-border spinner-border-sm text-primary ms-2 d-none"
                  role="status" id="loader-zerar-${r}"></span>
          </span>
          <p><strong>ENDERE√áO SECUND√ÅRIO:</strong><br>${n}</p>
          <p class="text-danger fw-bold fs-2 mb-1">SKU: ${e.sku}</p>
          <p><strong>PRODUTO:</strong> ${e.descricao}</p>
          <p><strong>COLE√á√ÉO:</strong> ${e.colecao||"‚Äî"}</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <div class="fw-bold text-muted small">QTDE TOTAL</div>
        <div class="fw-bold fs-1">${o}</div>
        <div class="row mt-2 g-2">${s}</div>
      </div>
    </div>`,l}function k(e,t){return t>0?Math.round(e/t*100):0}function $(){const e=()=>{const t=new Date(new Date-i.tempoInicio),o=String(t.getUTCHours()).padStart(2,"0"),r=String(t.getUTCMinutes()).padStart(2,"0"),n=String(t.getUTCSeconds()).padStart(2,"0");document.getElementById("cronometro").textContent=`${o}:${r}:${n}`,i.cronometroInterval=setTimeout(e,1e3)};e()}function S(){if(!i.tempoInicio)return"00:00:00";const e=new Date(new Date-i.tempoInicio);return[e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map(t=>String(t).padStart(2,"0")).join(":")}function A(){const e=localStorage.getItem("pickingProgresso");if(!e)return;const t=JSON.parse(e);document.getElementById("grupoSalvo").textContent=t.grupo;const o=new bootstrap.Modal(document.getElementById("modalRestaurarPicking"));o.show(),document.getElementById("btnConfirmarRestaurar").onclick=()=>{document.getElementById("grupo").value=t.grupo,document.getElementById("operador").value=t.operador,i.produtos=t.produtos||[],i.retirados=t.retirados||[],i.tempoInicio=t.tempoInicio?new Date(t.tempoInicio):new Date,document.getElementById("grupo").disabled=!0,document.getElementById("operador").disabled=!0,document.getElementById("btnIniciar").classList.add("d-none"),document.getElementById("btnFinalizar").classList.remove("d-none"),document.getElementById("card-tempo").classList.remove("d-none"),$(),y(),o.hide()},document.getElementById("btnCancelarRestaurar").onclick=()=>{localStorage.removeItem("pickingProgresso")}}function h(){var t;const e={grupo:document.getElementById("grupo").value,operador:document.getElementById("operador").value,produtos:i.produtos,retirados:i.retirados,tempoInicio:((t=i.tempoInicio)==null?void 0:t.toISOString())||null};localStorage.setItem("pickingProgresso",JSON.stringify(e))}function E(e,t="info"){const o=t==="success"?"bg-success":t==="error"?"bg-danger":t==="warning"?"bg-warning text-dark":"bg-primary",r=document.createElement("div");r.className=`toast fade show align-items-center text-white ${o} border-0`,r.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${e}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`,document.getElementById("toast-container").appendChild(r),setTimeout(()=>r.remove(),4e3)}function O(){window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||setTimeout(()=>{E("üì± Para instalar como app: use o menu ‚ãÆ e 'Instalar app'","warning")},3e3)}function P(){window.confetti&&window.confetti({particleCount:250,spread:90,origin:{y:.6}})}function y(){const e=document.getElementById("cards");e.innerHTML="";const t=parseInt(document.getElementById("qtdCards").value,10)||2;i.produtos.slice(0,t).forEach((a,c)=>{const d=L(a,c===0);e.appendChild(d)}),document.getElementById("pendentesList").innerHTML=i.produtos.map(a=>{var c;return`
    <div class="pendente-item">
      <div class="sku">SKU: ${a.sku}</div>
      <div class="descricao">${a.descricao} | Ref: ${a.sku.split("-")[0]}</div>
      <div class="endereco">${(c=a.endereco)==null?void 0:c.split("‚Ä¢")[0]}</div>
    </div>
  `}).join(""),document.getElementById("retiradosList").innerHTML=i.retirados.map(a=>`
    <div class="mb-2">
      ‚úÖ <strong>${a.sku}</strong>
      <span class="badge bg-primary">Grupo ${a.grupo}</span>
      <span class="badge bg-secondary">Caixa ${a.caixa}</span>
      <button
        class="btn btn-sm btn-outline-light ms-3"
        title="Desfazer"
        onclick="desfazerRetirada('${a.sku}', ${a.romaneio}, '${a.caixa}', ${a.grupo})"
      >
        üîÑ
      </button>
    </div>
  `).join("");const r=i.produtos.concat(i.retirados).reduce((a,c)=>{const d=c.distribuicaoAtual||c.distribuicaoOriginal;return a+((d==null?void 0:d.A)||0)+((d==null?void 0:d.B)||0)+((d==null?void 0:d.C)||0)+((d==null?void 0:d.D)||0)},0),n=i.retirados.reduce((a,c)=>{const d=c.distribuicaoOriginal;return a+d.A+d.B+d.C+d.D},0),s=k(n,r),l=document.getElementById("progressoPicking");l.style.width=`${s}%`,l.textContent=`${n}/${r} ‚Ä¢ ${s}%`,s<30?l.className="progress-bar bg-danger":s<70?l.className="progress-bar bg-warning text-dark":l.className="progress-bar bg-success",s===100&&P()}function T(e,t){document.querySelectorAll(".card-produto").forEach(o=>{(!e||o.innerHTML.includes(e))&&(o.classList.add(`feedback-${t}`),setTimeout(()=>o.classList.remove(`feedback-${t}`),800))})}function D(){const e=parseInt(document.getElementById("qtdCards").value,10);document.getElementById("qtdCardsLabel").textContent=e,localStorage.setItem("qtdCardsPreferido",e),y(),h()}function I(e,t="info"){const o=t==="success"?"bg-success":t==="error"?"bg-danger":t==="warning"?"bg-warning text-dark":"bg-primary",r=document.createElement("div");r.className=`toast fade show align-items-center text-white ${o} border-0`,r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive"),r.setAttribute("aria-atomic","true"),r.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${e}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;const n=document.getElementById("toast-container");n&&(n.appendChild(r),setTimeout(()=>r.remove(),4e3))}async function R(){const t=await(await fetch("/api/proxy?endpoint=/rest/v1/produtos?select=grupo")).json(),o=[...new Set(t.map(r=>parseInt(r.grupo)))].sort((r,n)=>r-n);document.getElementById("grupo").innerHTML=o.map(r=>`<option value="${r}">${r}</option>`).join("")}async function M(){const e=w(),t=[],o=1e3;let r=0;for(;;){const s=await(await fetch("/api/proxy?endpoint=/rest/v1/produtos_ref?select=sku,imagem,colecao",{headers:{...e,Range:`${r}-${r+o-1}`}})).json();if(t.push(...s),s.length<o)break;r+=o}window.mapaRefGlobal=new Map(t.map(n=>[n.sku.trim().toUpperCase(),n]))}async function U(e,t,o,r){const n={timestamp:new Date().toISOString(),operador:t,sku:e.sku,romaneio:e.romaneio,caixa:r,grupo:parseInt(o),status:"RETIRADO"};await fetch("/api/proxy?endpoint=/rest/v1/retiradas",{method:"POST",headers:w(),body:JSON.stringify(n)})}async function N(){var r;const e=document.getElementById("grupo").value,t=document.getElementById("operador").value;if(!e||!t)return I("Preencha grupo e operador","warning");document.getElementById("grupo").disabled=!0,document.getElementById("operador").disabled=!0,document.getElementById("btnIniciar").classList.add("d-none"),document.getElementById("btnFinalizar").classList.remove("d-none"),document.getElementById("card-tempo").classList.remove("d-none");const o=w();try{const s=await(await fetch(`/api/proxy?endpoint=/rest/v1/produtos?grupo=eq.${e}&select=*`,{headers:o})).json(),l=window.mapaRefGlobal||new Map,c=await(await fetch(`/api/proxy?endpoint=/rest/v1/retiradas?grupo=eq.${e}&select=sku,caixa`,{headers:o})).json(),d=new Map(c.map(u=>[u.sku.trim().toUpperCase(),u.caixa]));i.produtos=[],i.retirados=[];const p={};for(const u of s){const g=(u.sku||"").trim().toUpperCase(),m=(u.caixa||"").toUpperCase(),f=parseInt(u.qtd||0,10),B=((r=(u.endereco||"").split("‚Ä¢")[0])==null?void 0:r.trim())||"SEM ENDERE√áO",v=l.get(g);if(!p[g]){const C=/A(\d+)-B(\d+)-R(\d+)-C(\d+)-N(\d+)/.exec(B);p[g]={...u,sku:g,endereco:B,imagem:(v==null?void 0:v.imagem)||"",colecao:(v==null?void 0:v.colecao)||"‚Äî",distribuicaoAtual:{A:0,B:0,C:0,D:0},distribuicaoOriginal:{A:0,B:0,C:0,D:0},ordemEndereco:C?C.slice(1).map(Number):[999,999,999,999,999]}}const b=p[g];m==="A"&&(b.distribuicaoAtual.A+=f,b.distribuicaoOriginal.A+=f),m==="B"&&(b.distribuicaoAtual.B+=f,b.distribuicaoOriginal.B+=f),m==="C"&&(b.distribuicaoAtual.C+=f,b.distribuicaoOriginal.C+=f),m==="D"&&(b.distribuicaoAtual.D+=f,b.distribuicaoOriginal.D+=f)}for(const u of Object.values(p))d.has(u.sku)?(u.caixa=d.get(u.sku),i.retirados.push(u)):i.produtos.push(u);i.produtos.sort((u,g)=>{for(let m=0;m<u.ordemEndereco.length;m++)if(u.ordemEndereco[m]!==g.ordemEndereco[m])return u.ordemEndereco[m]-g.ordemEndereco[m];return 0}),i.tempoInicio=new Date,$(),y(),h()}catch(n){console.error("‚ùå Erro ao carregar produtos:",n),I("Erro ao carregar dados do Supabase","error")}}function q(){const e=["Alan Ramos","Anderson Dutra","Arthur Oliveira","Felipe Moraes","Filipe Silva","Gabriel Lagoa","Jo√£o Alves","Kaique Teixeira","Marrony Portugal","Nalbert Pereira","Rodrigo Novaes","Rony C√¥rrea","Ykaro Oliveira","Yohann Risso"];document.getElementById("operador").innerHTML=e.map(t=>`<option value="${t}">${t}</option>`).join("")}function x(){const e=document.getElementById("skuInput"),t=e.value.trim().toUpperCase(),o=document.getElementById("grupo").value,r=document.getElementById("operador").value;e.disabled=!0,document.querySelector(".input-group .btn").disabled=!0;const n=()=>{e.value="",e.disabled=!1,document.querySelector(".input-group .btn").disabled=!1,e.focus()},s=i.produtos.findIndex(p=>p.sku.toUpperCase()===t||(p.ean||"").toUpperCase()===t);if(s===-1)return E("Produto n√£o encontrado","error"),n();const l=i.produtos[s],a=l.distribuicaoAtual;let c="";if(a.A>0?(a.A--,c="A"):a.B>0?(a.B--,c="B"):a.C>0?(a.C--,c="C"):a.D>0&&(a.D--,c="D"),!c)return E("Produto sem caixa para retirar","error"),n();U(l,r,o,c),a.A+a.B+a.C+a.D===0&&(i.retirados.unshift({...l,caixa:c,grupo:o,distribuicaoOriginal:{...l.distribuicaoOriginal}}),i.produtos.splice(s,1)),T(l.sku,"success"),y(),h(),n()}function j(){clearTimeout(i.cronometroInterval);const e=document.getElementById("operador").value,t=document.getElementById("grupo").value,o={operador:e,grupo:t,tempoExecucao:S(),retirados:i.retirados};H(o),localStorage.removeItem("pickingProgresso"),i.produtos=[],i.retirados=[],i.tempoInicio=null,document.getElementById("grupo").disabled=!1,document.getElementById("operador").disabled=!1,document.getElementById("btnIniciar").classList.remove("d-none"),document.getElementById("btnFinalizar").classList.add("d-none"),document.getElementById("cards").innerHTML="",document.getElementById("pendentesList").innerHTML="",document.getElementById("retiradosList").innerHTML="",document.getElementById("cronometro").textContent="00:00:00",document.getElementById("ideal").textContent="",document.getElementById("progressoPicking").style.width="0%",document.getElementById("progressoPicking").textContent="0%",I("Pronto para iniciar novo picking! üöÄ","success")}function H(e){const{jsPDF:t}=window.jspdf,o=new t;o.setFont("helvetica","bold"),o.setFontSize(16),o.text("üì¶ Resumo de Picking",20,20),o.setFont("helvetica","normal"),o.setFontSize(12),o.text(`Operador: ${e.operador}`,20,35),o.text(`Grupo: ${e.grupo}`,20,42),o.text(`Tempo: ${e.tempoExecucao}`,20,49),o.text(`Data: ${new Date().toLocaleString()}`,20,56),o.text("‚úÖ Retirados:",20,70),e.retirados.forEach((r,n)=>{o.text(`${n+1}. SKU: ${r.sku} | Produto: ${r.descricao||"-"} | Caixa: ${r.caixa}`,20,80+n*7)}),o.save(`Picking_Grupo${e.grupo}_${e.operador}.pdf`)}document.addEventListener("DOMContentLoaded",async()=>{var e,t,o,r,n;try{window.env={SUPABASE_URL:void 0,GAS_ZERAR_URL:void 0},q(),await R(),await M(),A(),O(),(e=document.getElementById("btnIniciar"))==null||e.addEventListener("click",N),(t=document.getElementById("btnFinalizar"))==null||t.addEventListener("click",j),(o=document.getElementById("btnConfirmarSKU"))==null||o.addEventListener("click",x),(r=document.getElementById("skuInput"))==null||r.addEventListener("keydown",s=>{s.key==="Enter"&&x()}),(n=document.getElementById("qtdCards"))==null||n.addEventListener("input",D)}catch(s){console.error("‚ùå Erro ao carregar aplica√ß√£o:",s)}console.log("Main carregado")});
