(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();const i={produtos:[],retirados:[],tempoInicio:null,cronometroInterval:null};function x(){return{apikey:void 0,Authorization:"Bearer undefined","Content-Type":"application/json"}}function N(e,t=!1){var s,l;const o=Object.values(e.distribuicaoAtual).reduce((u,g)=>u+g,0),n=((s=e.endereco)==null?void 0:s.split("‚Ä¢")[0])||"SEM LOCAL",r=((l=e.endereco)==null?void 0:l.split("‚Ä¢")[1])||"‚Äî",a=["A","B","C","D"].map(u=>`
    <div class="col minicard">
      <div class="card text-center">
        <div class="card-header fw-bold text-secondary">${u}</div>
        <div class="card-body p-2">
          <h4 class="card-title text-danger m-0">${e.distribuicaoAtual[u]}</h4>
        </div>
      </div>
    </div>`).join(""),d=document.createElement("div");return d.className="col-12 col-md-6 col-lg-4 card-wrapper",d.innerHTML=`
    <div class="card card-produto ${t?"primary":""} h-100 p-3">
      <div class="row g-3">
        <div class="col-md-4 text-center">
          <img src="${e.imagem||""}" alt="${e.descricao||"Produto"}"
               class="img-fluid rounded shadow-sm card-img-produto" style="max-height: 250px;">
        </div>
        <div class="col-md-8">
          <p class="fw-bold fs-3 mb-1 endereco-label">
            ENDERE√áO: <span class="texto-endereco d-block">${n}</span>
          </p>
          <span onclick="zerarEnderecoExterno('${n}')" style="cursor:pointer;" title="Zerar Endere√ßo">
            <i class="bi bi-x-circle-fill text-danger ms-2 fs-5"></i>
            <span class="spinner-border spinner-border-sm text-primary ms-2 d-none"
                  role="status" id="loader-zerar-${n}"></span>
          </span>
          <p><strong>ENDERE√áO SECUND√ÅRIO:</strong><br>${r}</p>
          <p class="text-danger fw-bold fs-2 mb-1">SKU: ${e.sku}</p>
          <p><strong>PRODUTO:</strong> ${e.descricao}</p>
          <p><strong>COLE√á√ÉO:</strong> ${e.colecao||"‚Äî"}</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <div class="fw-bold text-muted small">QTDE TOTAL</div>
        <div class="fw-bold fs-1">${o}</div>
        <div class="row mt-2 g-2">${a}</div>
      </div>
    </div>`,d}function q(e){const t=String(Math.floor(e/3600)).padStart(2,"0"),o=String(Math.floor(e%3600/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");return`${t}:${o}:${n}`}function h(e,t=8.116){const o=Math.round(e*t);return q(o)}function F(e,t){return t>0?Math.round(e/t*100):0}function R(){const e=()=>{const t=new Date(new Date-i.tempoInicio),o=String(t.getUTCHours()).padStart(2,"0"),n=String(t.getUTCMinutes()).padStart(2,"0"),r=String(t.getUTCSeconds()).padStart(2,"0");document.getElementById("cronometro").textContent=`${o}:${n}:${r}`,i.cronometroInterval=setTimeout(e,1e3)};e()}function j(){if(!i.tempoInicio)return"00:00:00";const e=new Date(new Date-i.tempoInicio);return[e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map(t=>String(t).padStart(2,"0")).join(":")}function k(){const e=localStorage.getItem("pickingProgresso");if(!e)return;const t=JSON.parse(e);document.getElementById("grupoSalvo").textContent=t.grupo;const o=new bootstrap.Modal(document.getElementById("modalRestaurarPicking"));o.show(),document.getElementById("btnConfirmarRestaurar").onclick=()=>{document.getElementById("grupo").value=t.grupo,document.getElementById("operador").value=t.operador,i.produtos=t.produtos||[],i.retirados=t.retirados||[],i.tempoInicio=t.tempoInicio?new Date(t.tempoInicio):new Date,document.getElementById("grupo").disabled=!0,document.getElementById("operador").disabled=!0,document.getElementById("btnIniciar").classList.add("d-none"),document.getElementById("btnFinalizar").classList.remove("d-none"),document.getElementById("card-tempo").classList.remove("d-none"),R(),y(),o.hide()},document.getElementById("btnCancelarRestaurar").onclick=()=>{localStorage.removeItem("pickingProgresso")}}function w(){var t;const e={grupo:document.getElementById("grupo").value,operador:document.getElementById("operador").value,produtos:i.produtos,retirados:i.retirados,tempoInicio:((t=i.tempoInicio)==null?void 0:t.toISOString())||null};localStorage.setItem("pickingProgresso",JSON.stringify(e))}function C(e,t="info"){const o=t==="success"?"bg-success":t==="error"?"bg-danger":t==="warning"?"bg-warning text-dark":"bg-primary",n=document.getElementById("toast-container");if(!n){console.warn("‚ö†Ô∏è Toast container n√£o encontrado.");return}n.appendChild(r);const r=document.createElement("div");r.className=`toast fade show align-items-center text-white ${o} border-0`,r.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${e}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`,document.getElementById("toast-container").appendChild(r),setTimeout(()=>r.remove(),4e3)}function A(){window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||setTimeout(()=>{C("üì± Para instalar como app: use o menu ‚ãÆ e 'Instalar app'","warning")},3e3)}function H(){window.confetti&&window.confetti({particleCount:250,spread:90,origin:{y:.6}})}function y(){const e=document.getElementById("cards");e.innerHTML="";const t=parseInt(document.getElementById("qtdCards").value,10)||2;i.produtos.slice(0,t).forEach((s,l)=>{const u=N(s,l===0);e.appendChild(u)}),document.getElementById("pendentesList").innerHTML=i.produtos.map(s=>{var l;return`
    <div class="pendente-item">
      <div class="sku">SKU: ${s.sku}</div>
      <div class="descricao">${s.descricao} | Ref: ${s.sku.split("-")[0]}</div>
      <div class="endereco">${(l=s.endereco)==null?void 0:l.split("‚Ä¢")[0]}</div>
    </div>
  `}).join(""),document.getElementById("retiradosList").innerHTML=i.retirados.map(s=>`
    <div class="mb-2">
      ‚úÖ <strong>${s.sku}</strong>
      <span class="badge bg-primary">Grupo ${s.grupo}</span>
      <span class="badge bg-secondary">Caixa ${s.caixa}</span>
      <button
        class="btn btn-sm btn-outline-light ms-3"
        title="Desfazer"
        onclick="desfazerRetirada('${s.sku}', ${s.romaneio}, '${s.caixa}', ${s.grupo})"
      >
        üîÑ
      </button>
    </div>
  `).join("");const n=i.produtos.concat(i.retirados).reduce((s,l)=>{const u=l.distribuicaoAtual||l.distribuicaoOriginal;return s+u.A+u.B+u.C+u.D},0),r=i.retirados.reduce((s,l)=>{const u=l.distribuicaoOriginal;return s+u.A+u.B+u.C+u.D},0),a=F(r,n),d=document.getElementById("progressoPicking");d.style.width=`${a}%`,d.textContent=`${r}/${n} ‚Ä¢ ${a}%`,a<30?d.className="progress-bar bg-danger":a<70?d.className="progress-bar bg-warning text-dark":d.className="progress-bar bg-success",a===100&&H()}function G(e,t){document.querySelectorAll(".card-produto").forEach(o=>{(!e||o.innerHTML.includes(e))&&(o.classList.add(`feedback-${t}`),setTimeout(()=>o.classList.remove(`feedback-${t}`),800))})}function P(){const e=parseInt(document.getElementById("qtdCards").value,10);document.getElementById("qtdCardsLabel").textContent=e,localStorage.setItem("qtdCardsPreferido",e),y(),w()}function _(e){const t=document.getElementById("overlayCaixa"),o=document.getElementById("letraCaixa");o.textContent=e,t.classList.remove("hide"),t.classList.add("show"),t.style.display="flex",setTimeout(()=>{t.classList.remove("show"),t.classList.add("hide"),setTimeout(()=>t.style.display="none",500)},2e3)}function T(e){const t=document.getElementById(e);t?(t.classList.remove("d-none"),t.style.visibility="visible"):console.warn(`‚ö†Ô∏è mostrarLoaderInline: elemento #${e} n√£o encontrado`)}function O(e){const t=document.getElementById(e);t?(t.classList.add("d-none"),t.style.visibility="hidden"):console.warn(`‚ö†Ô∏è esconderLoaderInline: elemento #${e} n√£o encontrado`)}function E(e,t="info"){const o=t==="success"?"bg-success":t==="error"?"bg-danger":t==="warning"?"bg-warning text-dark":"bg-primary",n=document.createElement("div");n.className=`toast fade show align-items-center text-white ${o} border-0`,n.setAttribute("role","alert"),n.setAttribute("aria-live","assertive"),n.setAttribute("aria-atomic","true"),n.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${e}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;const r=document.getElementById("toast-container");r&&(r.appendChild(n),setTimeout(()=>n.remove(),4e3))}async function D(){const t=await(await fetch("/api/proxy?endpoint=/rest/v1/produtos?select=grupo")).json(),o=[...new Set(t.map(n=>parseInt(n.grupo)))].sort((n,r)=>n-r);document.getElementById("grupo").innerHTML=o.map(n=>`<option value="${n}">${n}</option>`).join("")}let S=!1;async function U(){if(S)return;S=!0;const e=x(),t=[],o=1e3;let n=0;for(;;){const a=await(await fetch(`/api/proxy?endpoint=/rest/v1/produtos_ref?select=sku,imagem,colecao&range=${n}-${n+o-1}`,{headers:e})).json();if(t.push(...a),a.length<o)break;n+=o}window.mapaRefGlobal=new Map(t.map(r=>[r.sku.trim().toUpperCase(),r])),console.log("‚úÖ mapaRefGlobal carregado:",t.length)}async function K(e,t,o,n){const a={timestamp:new Date().toLocaleString("sv-SE",{timeZone:"America/Sao_Paulo"}).replace(" ","T"),operador:t,sku:e.sku,romaneio:e.romaneio,caixa:n,grupo:parseInt(o),status:"RETIRADO"};console.log("üì§ Enviando retirada:",a);try{const d=await fetch("/api/proxy?endpoint=/rest/v1/retiradas",{method:"POST",headers:x(),body:JSON.stringify(a)});if(!d.ok){const s=await d.text();throw new Error(s)}console.log("‚úÖ Retirada registrada com sucesso!")}catch(d){console.error("‚ùå Falha ao registrar retirada:",d),E("Erro ao registrar retirada","error")}}async function M(){var n;console.log("‚öôÔ∏è carregarProdutos chamado");const e=document.getElementById("grupo").value,t=document.getElementById("operador").value;if(!e||!t)return E("Preencha grupo e operador","warning");document.getElementById("grupo").disabled=!0,document.getElementById("operador").disabled=!0,document.getElementById("btnIniciar").classList.add("d-none"),document.getElementById("btnFinalizar").classList.remove("d-none"),document.getElementById("card-tempo").classList.remove("d-none");const o=x();try{const a=await(await fetch(`/api/proxy?endpoint=/rest/v1/produtos?grupo=eq.${e}&select=*`,{headers:o})).json(),d=window.mapaRefGlobal||new Map,l=await(await fetch(`/api/proxy?endpoint=/rest/v1/retiradas?grupo=eq.${e}&select=sku,caixa`,{headers:o})).json(),u=new Map(l.map(c=>[c.sku.trim().toUpperCase(),c.caixa]));i.produtos=[],i.retirados=[];const g={};for(const c of a){const p=(c.sku||"").trim().toUpperCase(),m=(c.caixa||"").toUpperCase(),f=parseInt(c.qtd||0,10),$=((n=(c.endereco||"").split("‚Ä¢")[0])==null?void 0:n.trim())||"SEM ENDERE√áO",b=d.get(p.toUpperCase());if(!g[p]){const L=/A(\d+)-B(\d+)-R(\d+)-C(\d+)-N(\d+)/.exec($);g[p]={...c,sku:p,endereco:$,imagem:(b==null?void 0:b.imagem)||"",colecao:(b==null?void 0:b.colecao)||"‚Äî",distribuicaoAtual:{A:0,B:0,C:0,D:0},distribuicaoOriginal:{A:0,B:0,C:0,D:0},ordemEndereco:L?L.slice(1).map(Number):[999,999,999,999,999]}}const v=g[p];m==="A"&&(v.distribuicaoAtual.A+=f,v.distribuicaoOriginal.A+=f),m==="B"&&(v.distribuicaoAtual.B+=f,v.distribuicaoOriginal.B+=f),m==="C"&&(v.distribuicaoAtual.C+=f,v.distribuicaoOriginal.C+=f),m==="D"&&(v.distribuicaoAtual.D+=f,v.distribuicaoOriginal.D+=f)}for(const c of Object.values(g))u.has(c.sku)?(c.caixa=u.get(c.sku),i.retirados.push(c)):i.produtos.push(c);i.produtos.sort((c,p)=>{for(let m=0;m<c.ordemEndereco.length;m++)if(c.ordemEndereco[m]!==p.ordemEndereco[m])return c.ordemEndereco[m]-p.ordemEndereco[m];return 0}),i.tempoInicio=new Date,h(),R(),y(),w();const I=i.produtos.concat(i.retirados).reduce((c,p)=>{const m=p.distribuicaoAtual||p.distribuicaoOriginal;return c+m.A+m.B+m.C+m.D},0);document.getElementById("ideal").textContent=h(I)}catch(r){console.error("‚ùå Erro ao carregar produtos:",r),E("Erro ao carregar dados do Supabase","error")}}function Z(){const e=["Alan Ramos","Anderson Dutra","Arthur Oliveira","Felipe Moraes","Filipe Silva","Gabriel Lagoa","Jo√£o Alves","Kaique Teixeira","Marrony Portugal","Nalbert Pereira","Rodrigo Novaes","Rony C√¥rrea","Ykaro Oliveira","Yohann Risso"];document.getElementById("operador").innerHTML=e.map(t=>`<option value="${t}">${t}</option>`).join("")}async function B(){const e=document.getElementById("skuInput"),t=e.value.trim().toUpperCase(),o=document.getElementById("grupo").value,n=document.getElementById("operador").value;e.disabled=!0,document.querySelector(".input-group .btn").disabled=!0;const r=()=>{e.value="",e.disabled=!1,document.querySelector(".input-group .btn").disabled=!1,e.focus()},a=i.produtos.findIndex(g=>g.sku.toUpperCase()===t||(g.ean||"").toUpperCase()===t);if(a===-1)return C("Produto n√£o encontrado","error"),r();const d=i.produtos[a],s=d.distribuicaoAtual;let l="";if(s.A>0?(s.A--,l="A"):s.B>0?(s.B--,l="B"):s.C>0?(s.C--,l="C"):s.D>0&&(s.D--,l="D"),!l)return C("Produto sem caixa para retirar","error"),r();await K(d,n,o,l),s.A+s.B+s.C+s.D===0&&(i.retirados.unshift({...d,caixa:l,grupo:o,distribuicaoOriginal:{...d.distribuicaoOriginal}}),i.produtos.splice(a,1)),_(l),calcularTempoIdeal(),G(d.sku,"success"),y(),w(),r()}function z(){clearTimeout(i.cronometroInterval);const e=document.getElementById("operador").value,t=document.getElementById("grupo").value,o={operador:e,grupo:t,tempoExecucao:j(),retirados:i.retirados};V(o),localStorage.removeItem("pickingProgresso"),i.produtos=[],i.retirados=[],i.tempoInicio=null,document.getElementById("grupo").disabled=!1,document.getElementById("operador").disabled=!1,document.getElementById("btnIniciar").classList.remove("d-none"),document.getElementById("btnFinalizar").classList.add("d-none"),document.getElementById("cards").innerHTML="",document.getElementById("pendentesList").innerHTML="",document.getElementById("retiradosList").innerHTML="",document.getElementById("cronometro").textContent="00:00:00",document.getElementById("ideal").textContent="",document.getElementById("progressoPicking").style.width="0%",document.getElementById("progressoPicking").textContent="0%",E("Pronto para iniciar novo picking! üöÄ","success")}function V(e){const{jsPDF:t}=window.jspdf,o=new t;o.setFont("helvetica","bold"),o.setFontSize(16),o.text("üì¶ Resumo de Picking",20,20),o.setFont("helvetica","normal"),o.setFontSize(12),o.text(`Operador: ${e.operador}`,20,35),o.text(`Grupo: ${e.grupo}`,20,42),o.text(`Tempo: ${e.tempoExecucao}`,20,49),o.text(`Data: ${new Date().toLocaleString()}`,20,56),o.text("‚úÖ Retirados:",20,70),e.retirados.forEach((n,r)=>{o.text(`${r+1}. SKU: ${n.sku} | Produto: ${n.descricao||"-"} | Caixa: ${n.caixa}`,20,80+r*7)}),o.save(`Picking_Grupo${e.grupo}_${e.operador}.pdf`)}async function J(e){var l;const t=e.match(/A(\d+)-B(\d+)-R(\d+)/);if(!t)return E("‚ùå Endere√ßo inv√°lido","error");const o=encodeURIComponent(document.getElementById("operador").value),n=encodeURIComponent(new Date().toLocaleString()),r=`${t[1]}-${t[2]}-${t[3]}`,a=`loader-zerar-${e}`;if(!((l=window==null?void 0:window.env)==null?void 0:l.GAS_ZERAR_URL)){E("‚ùå URL de zeramento n√£o configurada","error");return}const s=`${window.env.GAS_ZERAR_URL}&WS=${encodeURIComponent(r)}&func=Update&ENDERECO=${encodeURIComponent(e)}&SKU=VAZIO&OPERADOR=${o}&TIME=${n}`;console.log(`üîó URL de zeramento: ${s}`),T(a);try{const u=await fetch(s),g=await u.text();if(!u.ok)throw new Error(g);console.log("üì§ Zeramento enviado:",s),console.log("üì© Resposta:",g),E(`‚úÖ Endere√ßo ${e} marcado para zeramento.`,"success"),Q(e)}catch{E("‚ùå Falha ao marcar zeramento.","error")}finally{O(a)}}function Q(e){var u,g,I;const t=i.produtos.findIndex(c=>{var m,f;return((f=(m=c.endereco)==null?void 0:m.split("‚Ä¢")[0])==null?void 0:f.trim())===e});if(t===-1){console.warn("‚ö†Ô∏è Produto com endere√ßo n√£o encontrado:",e);return}const[o]=i.produtos.splice(t,1),[n,r]=(o.endereco||"").split("‚Ä¢"),a=r==null?void 0:r.trim();if(!a||!/A\d+-B\d+-R\d+-C\d+-N\d+/.test(a)){console.warn("‚ö†Ô∏è Endere√ßo secund√°rio inv√°lido:",a),i.produtos.push(o),y(),w();return}o.endereco=a;const d=((u=/A(\d+)-B(\d+)-R(\d+)-C(\d+)-N(\d+)/.exec(a))==null?void 0:u.slice(1).map(Number))||[999,999,999,999,999];o.ordemEndereco=d;const s=((g=i.produtos[0])==null?void 0:g.ordemEndereco)??((I=i.retirados[0])==null?void 0:I.ordemEndereco)??[0,0,0,0,0];d.some((c,p)=>c>s[p])?(i.produtos.push(o),i.produtos.sort((c,p)=>{for(let m=0;m<c.ordemEndereco.length;m++)if(c.ordemEndereco[m]!==p.ordemEndereco[m])return c.ordemEndereco[m]-p.ordemEndereco[m];return 0})):i.produtos.push(o),console.log(`üîÅ Produto ${o.sku} reposicionado ap√≥s zeramento.`),y(),w(),h()}window.addEventListener("load",async()=>{var t,o,n,r;console.log("‚úÖ window.onload: DOM e assets carregados");const e=document.getElementById("btnIniciar");console.log("üîç btnIniciar:",e),e==null||e.addEventListener("click",()=>{console.log("üñ±Ô∏è Clique no bot√£o 'Iniciar'"),M()}),(t=document.getElementById("btnConfirmarSKU"))==null||t.addEventListener("click",()=>{console.log("üñ±Ô∏è Clique em Confirmar SKU"),B()}),(o=document.getElementById("btnFinalizar"))==null||o.addEventListener("click",()=>{console.log("üõë Clique em Finalizar"),z()}),(n=document.getElementById("skuInput"))==null||n.addEventListener("keydown",a=>{a.key==="Enter"&&(console.log("‚å®Ô∏è Enter pressionado no SKU"),B())}),(r=document.getElementById("qtdCards"))==null||r.addEventListener("input",()=>{console.log("üéöÔ∏è Alterou quantidade de cards"),P()});try{const a=await fetch("/api/env");if(!a.ok)throw new Error("API /api/env falhou");window.env=await a.json(),console.log("üîê Vari√°veis carregadas do /api/env:",window.env)}catch{console.warn("‚ö†Ô∏è Falha ao acessar /api/env, usando import.meta.env como fallback."),window.env={SUPABASE_URL:void 0,GAS_ZERAR_URL:void 0}}try{Z(),await D(),await U(),k(),A()}catch(a){console.error("‚ùå Erro ao carregar aplica√ß√£o:",a)}console.log("Main carregado ‚úÖ")});window.carregarProdutos=M;window.biparProduto=B;window.finalizarPicking=z;window.atualizarQtdCards=P;window.carregarGrupos=D;window.carregarTodosRefs=U;window.restaurarCacheLocal=k;window.checarModoStandalone=A;window.zerarEnderecoExterno=J;window.mostrarLoaderInline=T;window.esconderLoaderInline=O;console.log("Exportando fun√ß√µes para o console global ‚úÖ");console.log("üåü Bem-vindo ao sistema de Picking! Carregando...");
