<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Plaquinhas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: "Geist", "Segoe UI", sans-serif;
        background: #f8f9fa;
        color: #1a1d20;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <span>Gerando plaquinhas...</span>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      const { jsPDF } = window.jspdf;

      const SUPABASE_URL = "https://kinpwzuobsmfkjefnrdc.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpbnB3enVvYnNtZmtqZWZucmRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5OTgwMjcsImV4cCI6MjA2MzU3NDAyN30.btmwaLMSnXCmvKHQvYnw7ZngONqoejqnhbvazLhD1Io";
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      const grupo = new URLSearchParams(location.search).get("grupo");

      if (!grupo) {
        alert("Grupo não informado.");
        throw new Error("Grupo ausente.");
      }

      async function gerarPDF(grupo) {
        try {
          const grupoNum = Number(grupo);
          const { data, error } = await supabase
            .from("romaneios")
            .select("romaneio, qtd_pedidos, qtd_pecas")
            .eq("conjunto", grupoNum)
            .order("romaneio", { ascending: true });

          if (error || !data || data.length === 0) {
            alert("Erro ao carregar romaneios ou nenhum encontrado.");
            return;
          }

          const doc = new jsPDF({
            orientation: "landscape",
            unit: "mm",
            format: "a4",
          });

          const largura = 130;
          const altura = 85;
          const marginLeft = 20;
          const marginTop = 10;
          const espacoX = 15;
          const espacoY = 10;

          const posicoes = [
            { x: marginLeft, y: marginTop },
            { x: marginLeft + largura + espacoX, y: marginTop },
            { x: marginLeft, y: marginTop + altura + espacoY },
            {
              x: marginLeft + largura + espacoX,
              y: marginTop + altura + espacoY,
            },
          ];

          const dataHoje = new Date().toLocaleDateString("pt-BR");

          data.slice(0, 4).forEach((rom, index) => {
            const { x, y } = posicoes[index];
            const box = String.fromCharCode(65 + index);

            // Moldura externa
            doc.setDrawColor(0).setLineWidth(0.4).rect(x, y, largura, altura);

            // Título ROMANEIO
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text("ROMANEIO", x + 8, y + 12);

            // Faixa preta com número
            const faixaY = y + 14;
            doc
              .setFillColor(0, 0, 0)
              .rect(x + 8, faixaY, largura - 26, 20, "F");
            doc.setTextColor(255);
            doc.setFontSize(28);
            doc.text(
              `${rom.romaneio}`,
              x + 8 + (largura - 26) / 2,
              faixaY + 13,
              {
                align: "center",
              }
            );

            // Tabela
            const tableY = faixaY + 22;
            const rowHeight = 10;
            const rowWidth = largura - 26;
            const infos = [
              ["DATA", dataHoje],
              ["QTDE. PEDIDOS", String(rom.qtd_pedidos)],
              ["QTDE. PEÇAS", String(rom.qtd_pecas)],
            ];

            infos.forEach(([label, valor], i) => {
              const yLinha = tableY + i * rowHeight;
              doc.setDrawColor(0).rect(x + 8, yLinha, rowWidth, rowHeight);
              doc.setTextColor(0).setFontSize(11);
              doc.text(label, x + 10, yLinha + 6);
              doc.text(valor, x + 8 + rowWidth - 4, yLinha + 6, {
                align: "right",
              });
            });

            // Faixa lateral preta
            const faixaX = x + largura - 10;
            doc.setFillColor(0, 0, 0).rect(faixaX, y, 10, altura, "F");

            // Texto branco
            doc.setTextColor(255);
            doc.setFontSize(25);
            doc.text(`${grupoNum}`, faixaX + 5, y + 8, { align: "center" });

            // Texto rotacionado: "CAIXA"
            doc.saveGraphicsState();
            doc.setFontSize(25);
            doc.setTextColor(255);

            // Ponto de rotação: centro da palavra
            doc.setFont("helvetica", "bold");

            const caixaX = faixaX + 5;
            const caixaY = y + altura / 2;

            doc.setFontSize(25);
            doc.setTextColor(255);
            doc.text("CAIXA", caixaX, caixaY, {
              angle: -90,
              align: "center-middle",
            });
            doc.restoreGraphicsState();

            // Letra da caixa (ex: A)
            doc.setFontSize(40);
            doc.text(box, faixaX + 5, y + altura - 10, { align: "center" });
          });

          doc.output("dataurlnewwindow");
        } catch (err) {
          console.error("❌ Erro ao gerar PDF:", err);
          alert("Erro ao gerar PDF: " + err.message);
        }
      }

      gerarPDF(grupo);
    </script>
  </body>
</html>
